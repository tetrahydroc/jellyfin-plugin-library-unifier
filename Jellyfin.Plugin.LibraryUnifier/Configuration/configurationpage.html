<!DOCTYPE html>
<html>

<head>
    <title>Library Unifier</title>
</head>

<body>
    <div data-role="page" class="page type-interior pluginConfigurationPage libraryUnifierConfigurationPage"
        data-require="emby-input,emby-button">
        <div data-role="content">
            <div class="content-primary">
                <form class="libraryUnifierConfigurationPage">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">Library Unifier</h2>
                        <a is="emby-linkbutton" class="raised button-alt headerHelpButton emby-button" target="_blank"
                            href="https://github.com/thc/jellyfin-plugin-library-unifier">Help</a>
                    </div>
                    <div class="verticalSection">
                        <p>This plugin creates a unified library structure using symlinks to merge series from different folders.</p>
                        <p>Series are matched by metadata provider IDs (TVDB, IMDB, TMDB) to ensure accurate merging.</p>
                        <p> If you find find duplicates after creating you can try manually assigning a tmdb/imdb to the media and rerunning</p>
                        <p><strong>How to use:</strong></p>
                        <ol>
                            <li>Set the output path below where the unified library will be created</li>
                            <li>Click "Create Unified Library" to generate the symlinked structure</li>
                            <li>Add the output path as a new TV library in Jellyfin</li>
                        </ol>
                        <br />
                    </div>

                    <div class="verticalSection">
                        <h3 class="sectionTitle">Settings</h3>
                        <div class="inputContainer">
                            <label class="inputLabel" for="txtUnifiedLibraryPath">Unified Library Output Path:</label>
                            <input is="emby-input" type="text" id="txtUnifiedLibraryPath"
                                placeholder="/path/to/unified-tv (e.g. /storage/tv-unified)" />
                            <div class="fieldDescription">Path where the unified library structure will be created using symlinks/hardlinks.</div>
                        </div>
                        <div class="checkboxContainer">
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="chkPreferHardlinks" />
                                <span>Prefer hardlinks over symlinks (requires same filesystem)</span>
                            </label>
                        </div>
                        <div class="checkboxContainer">
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="chkEnableAutoIdentify" />
                                <span>Auto-identify unmatched series (attempts to find provider IDs for series Jellyfin couldn't match)</span>
                            </label>
                        </div>
                    </div>

                    <div class="verticalSection">
                        <h3 class="sectionTitle">Merge Versions Settings</h3>
                        <p>Automatically merge duplicate media files (same content, different quality) into a single entry with multiple playable versions.</p>
                        <div class="checkboxContainer">
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="chkEnableMergeMovies" />
                                <span>Auto-merge duplicate movies (matches by TMDB ID)</span>
                            </label>
                        </div>
                        <div class="checkboxContainer">
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="chkEnableMergeEpisodes" />
                                <span>Auto-merge duplicate episodes (matches by series, season, episode name/number)</span>
                            </label>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel" for="txtLocationsExcluded">Paths to exclude from merging (one per line):</label>
                            <textarea is="emby-textarea" id="txtLocationsExcluded" rows="3"
                                placeholder="/path/to/exclude&#10;/another/path"></textarea>
                            <div class="fieldDescription">Media in these paths will not be merged with other versions.</div>
                        </div>
                    </div>
                    <br />

                    <button is="emby-button" type="button" class="raised button-submit block emby-button"
                        id="save-btn" onclick=save()><span>Save</span></button>

                    <h3 class="sectionTitle">Unified Library Actions</h3>
                    <button is="emby-button" type="button" class="raised block"
                        onclick=createUnifiedLibrary()><span>Create Unified Library</span></button>
                    <button is="emby-button" type="button" class="raised block"
                        onclick=removeUnifiedLibrary()><span>Remove Unified Library</span></button>

                    <h3 class="sectionTitle">Merge Actions</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button is="emby-button" type="button" class="raised"
                            onclick=mergeMovies()><span>Merge Movies</span></button>
                        <button is="emby-button" type="button" class="raised"
                            onclick=mergeEpisodes()><span>Merge Episodes</span></button>
                    </div>
                    <h3 class="sectionTitle">Split Actions</h3>
                    <p style="color: #f0ad4e; font-size: 0.9em;">⚠️ Split will undo all merges - use with caution</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button is="emby-button" type="button" class="raised"
                            onclick=splitMovies()><span>Split Movies</span></button>
                        <button is="emby-button" type="button" class="raised"
                            onclick=splitEpisodes()><span>Split Episodes</span></button>
                    </div>
                </form>
            </div>
        </div>

        <script type="text/javascript">
            var pluginId = "b8e3c5a1-9d4f-4e2b-8c6a-1f3d5e7b9a0c";

            function createUnifiedLibrary() {
                var path = document.getElementById('txtUnifiedLibraryPath').value;
                if (!path) {
                    Dashboard.alert({ message: "Please enter a unified library path and save first." });
                    return;
                }
                var request = {
                    url: ApiClient.getUrl('LibraryUnifier/Create'),
                    type: 'POST'
                };
                ApiClient.fetch(request).then(function () {
                    Dashboard.alert("Creating unified library... Check Jellyfin logs for progress.");
                }).catch(function () {
                    Dashboard.alert({
                        message: "Unexpected error occurred!"
                    });
                });
            }

            function removeUnifiedLibrary() {
                var request = {
                    url: ApiClient.getUrl('LibraryUnifier/Remove'),
                    type: 'POST'
                };
                ApiClient.fetch(request).then(function () {
                    Dashboard.alert("Removing unified library...");
                }).catch(function () {
                    Dashboard.alert({
                        message: "Unexpected error occurred!"
                    });
                });
            }

            function mergeMovies() {
                var request = {
                    url: ApiClient.getUrl('LibraryUnifier/MergeMovies'),
                    type: 'POST'
                };
                ApiClient.fetch(request).then(function () {
                    Dashboard.alert("Merging duplicate movies... Check Jellyfin logs for progress.");
                }).catch(function () {
                    Dashboard.alert({
                        message: "Unexpected error occurred!"
                    });
                });
            }

            function mergeEpisodes() {
                var request = {
                    url: ApiClient.getUrl('LibraryUnifier/MergeEpisodes'),
                    type: 'POST'
                };
                ApiClient.fetch(request).then(function () {
                    Dashboard.alert("Merging duplicate episodes... Check Jellyfin logs for progress.");
                }).catch(function () {
                    Dashboard.alert({
                        message: "Unexpected error occurred!"
                    });
                });
            }

            function splitMovies() {
                if (!confirm("This will split ALL merged movies back to individual entries. Continue?")) {
                    return;
                }
                var request = {
                    url: ApiClient.getUrl('LibraryUnifier/SplitMovies'),
                    type: 'POST'
                };
                ApiClient.fetch(request).then(function () {
                    Dashboard.alert("Splitting merged movies... Check Jellyfin logs for progress.");
                }).catch(function () {
                    Dashboard.alert({
                        message: "Unexpected error occurred!"
                    });
                });
            }

            function splitEpisodes() {
                if (!confirm("This will split ALL merged episodes back to individual entries. Continue?")) {
                    return;
                }
                var request = {
                    url: ApiClient.getUrl('LibraryUnifier/SplitEpisodes'),
                    type: 'POST'
                };
                ApiClient.fetch(request).then(function () {
                    Dashboard.alert("Splitting merged episodes... Check Jellyfin logs for progress.");
                }).catch(function () {
                    Dashboard.alert({
                        message: "Unexpected error occurred!"
                    });
                });
            }

            var config = {};

            ApiClient.getPluginConfiguration(pluginId).then(function (savedConfig) {
                config = savedConfig || {};

                document.getElementById('txtUnifiedLibraryPath').value = config.UnifiedLibraryPath || '';
                document.getElementById('chkPreferHardlinks').checked = config.PreferHardlinks !== false;
                document.getElementById('chkEnableAutoIdentify').checked = config.EnableAutoIdentify !== false;
                document.getElementById('chkEnableMergeMovies').checked = config.EnableMergeMovies === true;
                document.getElementById('chkEnableMergeEpisodes').checked = config.EnableMergeEpisodes === true;
                document.getElementById('txtLocationsExcluded').value = (config.LocationsExcludedFromMerge || []).join('\n');
            });

            function save() {
                var unifiedPath = document.getElementById('txtUnifiedLibraryPath').value;
                var preferHardlinks = document.getElementById('chkPreferHardlinks').checked;
                var enableAutoIdentify = document.getElementById('chkEnableAutoIdentify').checked;
                var enableMergeMovies = document.getElementById('chkEnableMergeMovies').checked;
                var enableMergeEpisodes = document.getElementById('chkEnableMergeEpisodes').checked;
                var locationsExcluded = document.getElementById('txtLocationsExcluded').value
                    .split('\n')
                    .map(function(s) { return s.trim(); })
                    .filter(function(s) { return s.length > 0; });

                ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                    config.UnifiedLibraryPath = unifiedPath;
                    config.PreferHardlinks = preferHardlinks;
                    config.EnableAutoIdentify = enableAutoIdentify;
                    config.EnableMergeMovies = enableMergeMovies;
                    config.EnableMergeEpisodes = enableMergeEpisodes;
                    config.LocationsExcludedFromMerge = locationsExcluded;
                    ApiClient.updatePluginConfiguration(pluginId, config).then(function (res) {
                        Dashboard.processPluginConfigurationUpdateResult(res);
                    });
                });
            }
        </script>
    </div>
</body>

</html>
