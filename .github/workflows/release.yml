name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update version in csproj
        run: |
          sed -i "s/<AssemblyVersion>.*<\/AssemblyVersion>/<AssemblyVersion>${{ steps.version.outputs.version }}<\/AssemblyVersion>/" Jellyfin.Plugin.LibraryUnifier/Jellyfin.Plugin.LibraryUnifier.csproj
          sed -i "s/<FileVersion>.*<\/FileVersion>/<FileVersion>${{ steps.version.outputs.version }}<\/FileVersion>/" Jellyfin.Plugin.LibraryUnifier/Jellyfin.Plugin.LibraryUnifier.csproj

      - name: Build
        run: dotnet build --configuration Release

      - name: Create plugin package
        run: |
          cd Jellyfin.Plugin.LibraryUnifier/bin/Release/net9.0
          zip -r ../../../../library-unifier-v${{ steps.version.outputs.version }}.zip *.dll *.json

      - name: Generate checksum
        id: checksum
        run: |
          checksum=$(md5sum library-unifier-v${{ steps.version.outputs.version }}.zip | awk '{print $1}')
          echo "checksum=$checksum" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: library-unifier-v${{ steps.version.outputs.version }}.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update repository.json
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CHECKSUM="${{ steps.checksum.outputs.checksum }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          REPO_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}/library-unifier-v${VERSION}.zip"

          # Get default branch and fetch latest repository.json
          DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
          git fetch origin $DEFAULT_BRANCH
          git checkout origin/$DEFAULT_BRANCH -- repository.json 2>/dev/null || echo "No existing repository.json"

          # Create new version object
          NEW_VERSION=$(cat << EOF
          {
            "version": "${VERSION}",
            "changelog": "See release notes on GitHub",
            "targetAbi": "10.11.0.0",
            "sourceUrl": "${REPO_URL}",
            "checksum": "${CHECKSUM}",
            "timestamp": "${TIMESTAMP}"
          }
          EOF
          )

          # If repository.json exists, prepend new version to existing versions array
          if [ -f repository.json ]; then
            # Use jq to prepend new version to versions array, avoiding duplicates
            jq --argjson newver "$NEW_VERSION" '
              .[0].versions = ([$newver] + [.[0].versions[] | select(.version != $newver.version)])
            ' repository.json > repository.json.tmp && mv repository.json.tmp repository.json
          else
            # Create new repository.json if it doesn't exist
            cat > repository.json << EOF
          [
            {
              "guid": "b8e3c5a1-9d4f-4e2b-8c6a-1f3d5e7b9a0c",
              "name": "Library Unifier",
              "overview": "Creates a unified TV library using symlinks to merge series from different folders",
              "description": "This plugin creates a unified library structure using symlinks/hardlinks. Series are matched by metadata provider IDs (TVDB, IMDB, TMDB) to ensure accurate merging.",
              "owner": "tetrahydroc",
              "category": "General",
              "versions": [
                {
                  "version": "${VERSION}",
                  "changelog": "See release notes on GitHub",
                  "targetAbi": "10.11.0.0",
                  "sourceUrl": "${REPO_URL}",
                  "checksum": "${CHECKSUM}",
                  "timestamp": "${TIMESTAMP}"
                }
              ]
            }
          ]
          EOF
          fi

      - name: Commit repository.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Get default branch name
          DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
          git fetch origin $DEFAULT_BRANCH
          git checkout $DEFAULT_BRANCH
          git add repository.json
          git commit -m "Update repository.json for v${{ steps.version.outputs.version }}" || echo "No changes to commit"
          git push origin $DEFAULT_BRANCH
